import Heading from '@react/react-spectrum/Heading';
import {TreeView} from '@react/react-spectrum/TreeView';
import {ExampleDS, ds, ds2, renderItem} from '../helpers/TreeView';

A **TreeView** displays a heirarchical list of data with items that can be expanded and collapsed. It supports
many advanced features like asynchronous data loading, drag and drop both into and out of the tree, multiple
selection, keyboard navigation, and more. It is designed to scale to collections of any size using a virtual scroller 
that only renders the currently visible items into the DOM.

## Example

<TreeView
  className="example-treeview"
  dataSource={ds}
  renderItem={renderItem} />

```jsx
import {TreeView} from '@react/react-spectrum/TreeView';

<TreeView
  dataSource={dataSource}
  renderItem={renderItem} />
```

See below for details about these props.

## Overview

To set up a TreeView, a couple pieces are required: a data source to provide the items to display, and a `renderItem` 
function to render the UI for an individual item.

### Data Sources

A data source provides the data for a TreeView to display, and responds to user initiated actions such as drag and drop.
Data sources can be shared across multiple types of views that display heirarchical data, e.g. TreeView and [ColumnView](/components/ColumnView).
Since TreeView uses objects as keys, data returned by data sources must be unique: the same object cannot be returned more than once.

There is a base class for data sources that can be used by TreeView called [TreeDataSource](/classes/TreeDataSource), which supports asynchronous
loading of data, and events to update data later. To provide data, implement the `getChildren` method and return the data for
the child items of the provided parent. If the parent is `null`, then provide the root items. You must also implement the
`hasChildren` method to let TreeView know whether an item should display the disclosure indicator indicating it has children.

```javascript
import TreeDataSource from '@react/react-spectrum/TreeDataSource';

class MyDataSource extends TreeDataSource {
  async getChildren(parent) {
    if (!parent) {
      // If parent is null, load the root items.
      return [...];
    }

    // Otherwise, load the children.
    return [...];
  }

  hasChildren(parent) {
    // Return whether the parent has children
    return true;
  }
}
```

When data in the data source changes, perhaps in response to some external event such as a server update, the data source 
should emit events. The tree view listens for these events and updates its views as necessary. There are helper methods as part 
of the base data source class that you can call to insert, update, remove, or move items in the tree view. You can also use 
transactions to group multiple updates together into a single animation. See the [API docs](/classes/TreeDataSource) for details.

### Item Renderers

The last required piece for a TreeView is a `renderItem` prop, which is just a function to render the contents of an item.
It receives the data for the item to render.

```jsx
function renderItem(item) {
  return <span>{...}</span>;
}
```

## Expanding and Collapsing Items

TreeView lets the user expand and collapse branches in the tree on demand. As items are expanded, the TreeView calls the
data source's `getChildren` method to load the child items as needed. The `onToggleItem` prop will also be called to notify
you that an item was expanded or collapsed.

To programmatically expand or collapse items, there are three methods you can use: `expandItem`, `collapseItem`, and `toggleItem`.
To call them, you will need a React ref to the TreeView instance.

```jsx
class MyComponent extends React.Component {
  render() {
    return (
      <TreeView
        {...otherProps}
        onToggleItem={(item) => {}}
        ref={t => this.treeView = t} />
    );
  }

  someMethod() {
    this.treeView.expandItem(item);
  }
}
```

## Selection

TreeView supports selection out of the box, optionally with support for selecting multiple items simultaneously. Selection can
be enabled using the `allowsSelection` prop. To enable multiple selection, use the `allowsMultipleSelection` prop. If you want
to always enforce a selection and prevent the user from deselecting all items, set the `allowsEmptySelection` prop to `false`.

To handle selection changes, you can use the `onSelectionChange` prop. This will be passed a list of item objects, as provided
by the data source.

To set the selection programmatically, provide the `selectedItems` prop to the TreeView. This should be an array of item objects,
with object identity equal to the ones provided by the data source.

```jsx
<TreeView
  {...otherProps}
  allowsSelection
  selectedItems={[...]}
  onSelectionChange={(selectedItems) => {}} />
```

## Object Equality

Since TreeView uses objects as keys to many of its methods, the items you return from `getChildren` might not be the same objects
you pass to the `selectedItems` prop or other methods. Perhaps you only have the ids until the full item objects are actually
loaded. In order for the column view to know which objects you are referring to, you can implement the `isItemEqual` comparator method 
on your data source and return a boolean to determine if two items are equal. Then you could pass objects with only an id to the 
`selectedItems` prop on initial render, for example.

```javascript
class MyDataSource extends TreeDataSource {
  // ...

  isItemEqual(a, b) {
    return a.id === b.id;
  }
}
```

## Drag and Drop

TreeView supports both dragging items from a tree (a drag source), as well as dropping files or other objects into a tree (a drop target).
It uses the native HTML5 drag and drop API, so it is easy to integrate with other drag and drop solutions that other components might use.
You can provide custom data to be passed with the drag, which will be received by the drop target, and provide a custom view to be
displayed under the cursor while dragging.

The following example shows how items can be dragged from one TreeView to another. Items on the right can also be moved within the tree.

<div style={{display: 'flex', justifyContent: 'space-around'}}>
  <TreeView
    dataSource={ds}
    renderItem={renderItem}
    className="example-treeview"
    canDragItems
    allowsSelection
    allowsMultipleSelection />
  <TreeView
    dataSource={ds2}
    renderItem={renderItem}
    className="example-treeview"
    acceptsDrops
    canDragItems
    allowsSelection
    allowsMultipleSelection />
</div>

### Drag Sources

To enable dragging items from a TreeView, pass the `canDragItems` prop. This is all you need to do to enable basic support for dragging items.
If you want to customize how the drag and drop works, there are some additional functions you can override.

#### Customizing the drag view

By default, the entire item will be rendered under the cursor while dragging. To customize this, you can provide the `renderDragView` prop
to TreeView to render any custom view you want. It is passed a target object representing the item the user actually clicked and dragged from,
along with the selected items for all items that would be dragged.

```jsx
<TreeView
  {...otherProps}
  renderDragView={(targetItem, selectedItems) => <div>My custom drag view</div>} />
```

#### Customizing the drag data

By default, the selected item objects are serialized to JSON and passed along with the drag to the drop target. This will work
if the only drop targets you want to support are other react-spectrum components, but you may want to support a custom data 
format for your content that will work across applications and frameworks. You can also provide data in multiple representations, so that many
different receiving applications can handle the drop. To do this, you can override the `prepareDragData` method of your
data source.

```javascript
class MyDataSource extends TreeDataSource {
  // ...
  
  prepareDragData(targetItem, dataTransfer, selectedItems) {
    // Add plain text representation
    dataTransfer.setData('text/plain', 'some text');

    // Add rich text representation
    dataTransfer.setData('text/html', '<strong>some bold text</strong>');

    // Add custom data
    dataTransfer.setData('my-custom-format', 'some data');
  }
}
```

### Drop Targets

To enable dropping files or other objects in a TreeView, pass the `acceptsDrops` prop. This can be a boolean to accept all drops,
or a list of allowed drag types (e.g. `Files`, `text/plain` or your custom format name).

#### Handling drops

By default, TreeView will handle drops from TreeViews or other react-spectrum components, but you may need to support dropping files 
or other custom types of objects. To do this, you need to implement the `itemsForDrop` method on your data source. This method is passed 
the target item object and the data transfer object from the drag, and should return items that should be dropped.

Once those items are chosen, they are inserted into the TreeView automatically. If you want to do any custom handling,
e.g. uploading dropped files, or performing other custom logic, you can override the `performDrop` method.

```javascript
class MyDataSource extends TreeDataSource {
  // ...
  
  itemsForDrop(targetItem, dataTransfer) {
    // parse your custom format
    return JSON.parse(dataTransfer.getData('my-custom-format'));
  }

  performDrop(targetItem, index, dropOperation, items) {
    // custom logic here
  }
}
```

## Accessibility

TreeView implements accessibility using the [WAI-ARIA 1.1 Tree View](https://www.w3.org/TR/wai-aria-practices-1.1/#TreeView) design pattern. It handles multiselection, item focusing, and is fully keyboard accessible out of the box.
The TreeView does not have a keyboard or screen reader accessible equivalent for drag and drop operations, and drag and drop should never be the only way to interact with a feature, such as manipulating the order or hierarchy of items in the TreeView or moving items between TreeViews.

### Labelling

A TreeView can be labelled to provide context for Accessibility using either the `aria-label` or `aria-labelledby` prop.

#### Using `aria-label`

```jsx
<TreeView
  aria-label="Tree View"
  dataSource={ds}
  renderItem={renderItem}
  allowsSelection
  allowsMultipleSelection />
```

#### Using `aria-labelledby`

```jsx
<Heading size={5} id="treeview-heading-id">
  Tree View
</Heading>
<TreeView
  aria-labelledby="treeview-heading-id"
  dataSource={ds}
  renderItem={renderItem}
  allowsSelection
  allowsMultipleSelection />
```

## Internationalization

To internationalize a TreeView, you should provide localized content as needed, for example item content formatting.
